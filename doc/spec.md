# 開発要件定義書: 軽量・音量連動ビジュアライザー・フィラー除去搭載 AI音声入力ツール

## 1. プロジェクト概要

Windows環境において、グローバルホットキーで起動・終了し、OpenAI Whisper APIを用いて音声をテキスト化、アクティブなアプリケーションに自動入力するPython製デスクトップアプリ。
録音中は邪魔にならないオーバーレイUIを表示し、音量に連動したビジュアライザーアニメーションを描画する。
また、APIキーの登録UIを実装し、セットアップの簡易化を図る。

## 2. 技術スタック

- OS: Windows 11
- 言語: Python 3.x
- GUIフレームワーク: Tkinter (Python標準ライブラリ)
- 音声処理: sounddevice, numpy, scipy
- AI API: OpenAI API (Whisper model)
- 入力制御: keyboard, pyperclip, pyautogui
- 設定管理: python-dotenv (または json/ini設定ファイル)
- 文字列処理: re (正規表現)

## 3. 機能要件

### 3.1 起動・設定フロー

- **起動時チェック:** アプリ起動時に、OSの資格情報マネージャー（Credential Manager）からAPIキーを取得できるか確認する。
- **APIキー登録画面:**
  - APIキーが未登録の場合、メイン機能（録音待機）には進まず、まず「APIキー登録ウィンドウ」を表示する。
  - **デザイン:**
    - ダークテーマ（背景色: #202020）。
    - ウィンドウサイズ: 幅720px, 高さ220px。
  - **構成要素:**
    - APIキー入力フィールド（パスワードマスク表示）。
    - 登録ボタン（アイコン「✔」、ティールグリーン配色、ホバーエフェクトあり）。
    - 入力フィールドとボタンは横並びに配置。
    - 「APIキーの取得方法はこちら」リンク。
  - **保存:** 入力されたキーは `keyring` ライブラリを使用してOSのセキュアなストレージに保存する（ファイルには保存しない）。
- **エラーハンドリング:** APIキーが無効で認証エラーが発生した場合も、設定画面を再表示してキーの再入力を促す。

### 3.2 録音・制御機能

- トグル操作: 特定のホットキー（デフォルト: F2）を押下することで録音の開始・停止を切り替える。
- 音声取得: デフォルトのマイクデバイスから音声ストリームを取得する。
- キャンセル機能: Escキー押下時は、録音を破棄してUIを即座に閉じる。
- **一時ファイル管理:** 録音データは一時ファイルとして保存されるが、文字起こし完了後またはキャンセル時に自動的に削除される。

### 3.3 UI/UX機能（Visualizer）

- ウィンドウ特性:
  - タイトルバーなし（Frameless）、常に最前面（Always on Top）、半透明（Alpha 0.85）。
  - 画面下部中央に配置。幅300px。
- アニメーション:
  - 録音中: 音量（RMS）に応じて50本のバーが伸縮する波形ビジュアライザー。
  - 高感度設定: 小さな声でも反応するようにゲインを調整済み。
- ステータス表示:
  - 録音中: 波形が激しく動く。
  - 処理中 (Thinking): テキスト表示の代わりに、波形がゆっくりと明滅・伸縮する「ブレス（呼吸）アニメーション」を表示。
  - 完了時: UI非表示。
- **トレイアイコン:** モダンなマイクデザイン（プログラム描画）を使用。
- **セキュリティ:** APIキーは `.env` ではなくWindows Credential Managerで管理。

### 3.4 音声認識・フィラー除去フロー

1. 録音データ保存: 録音停止後、一時WAVファイルを生成。
2. API送信 (Whisper): OpenAI API にWAVファイルを送信する。
   - Prompt指示: `prompt` パラメータに「フィラー（えー、あー）を含まない、整形された日本語の文章」を指定。
3. ポストプロセス: 正規表現で残存フィラーや不要な空白を除去。
4. ハルシネーション対策: 特定の幻覚フレーズ（「ご視聴ありがとうございました」等）を検知してブロック。
5. 出力: クリップボード経由で自動ペースト (Ctrl+V)。

## 4. 非機能要件

- パフォーマンス: UI描画と音声処理のスレッド分離。
- ユーザビリティ: 初回起動時のセットアップ障壁を低くする。
- セキュリティ: APIキーは適切に保存し、UI上の入力フィールドでは伏せ字（**\*\*\*\***）表示などが望ましい。

## 5. 推奨ライブラリ構成 (requirements.txt)

- openai
- keyboard
- sounddevice
- numpy
- scipy
- pyperclip
- pyautogui
- python-dotenv

## 6. ドキュメント要件 (readme.md)

成果物として納品する `readme.md` には、以下のセクションを必ず日本語で記載すること。

1. **概要:** ツールの説明と特徴。
2. **インストール方法:** `pip install -r requirements.txt` などの手順。
3. **OpenAI APIキーの取得方法（重要）:**
   - OpenAIプラットフォームへのアクセス手順。
   - クレジットカード登録（Credit balanceチャージ）の必要性についての注記。
   - 新しいシークレットキーの作成方法とコピー手順。
   - 取得したキーを本ツールに登録する流れ。
4. **使い方:** ホットキー操作の説明。

## 7. 実装のヒント（AIへの指示用）

- 設定ファイル管理クラス (`ConfigManager`) を作成し、`.env` の読み書きをカプセル化すると良い。
- Tkinterで入力ダイアログを作る際は `simpledialog` を使うか、カスタムToplevelウィンドウを作成してデザインを統一すること。
